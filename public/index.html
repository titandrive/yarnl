<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#a78bfa">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>Yarnl - Crochet Project Manager</title>
    <script>
        // Set theme and background immediately to prevent flash between splash screen and page
        const theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        var bgColor = localStorage.getItem('themeBgColor') || '#0f0a1a';
        document.documentElement.style.background = bgColor;
        // Set mascot immediately to prevent flash
        const savedMascot = localStorage.getItem('selectedMascot');
        if (savedMascot) {
            document.write('<link rel="icon" type="image/png" sizes="128x128" href="' + savedMascot + '">');
        } else {
            document.write('<link rel="icon" type="image/png" sizes="128x128" href="mascots/default.png">');
        }
        // Hide login and show correct tab immediately for returning users
        if (localStorage.getItem('authenticated') === 'true') {
            if (localStorage.getItem('viewingPatternId')) {
                // Resuming into pattern viewer ‚Äî hide everything to prevent tab flash
                document.write('<style id="early-tab-style">#login-container{display:none!important}.container{display:block!important}.tabs{display:none!important}.tab-content{display:none!important}</style>');
            } else {
                var startTab = localStorage.getItem('activeTab') || localStorage.getItem('defaultPage') || 'current';
                document.write('<style id="early-tab-style">#login-container{display:none!important}.container{display:block!important}.tab-content{display:none!important}.tab-content#' + startTab + '{display:block!important}</style>');
            }
        } else {
            // Not authenticated ‚Äî hide app container, show login
            document.write('<style id="early-tab-style">.container{display:none!important}</style>');
        }
    </script>
    <link rel="preload" href="fonts/jetbrains-mono-latin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="styles.css?v=170">
    <style>
        [data-theme="nuked-dark"] header,
        [data-theme="nuked-dark"] header h1,
        [data-theme="nuked-dark"] header .subtitle {
            color: #0d4020 !important;
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><img id="login-mascot" src="/mascots/jimmy.default.png?v=1" alt="Yarnl" class="login-mascot">Yarnl</h1>
                <p class="login-subtitle">Your self-hosted crochet companion</p>
            </div>

            <form id="login-form" class="login-form">
                <div class="login-form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" required autocomplete="username" placeholder="Enter username">
                </div>

                <div class="login-form-group" id="password-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" autocomplete="current-password" placeholder="Enter password (if set)">
                </div>

                <button type="submit" class="btn login-btn">Log In</button>

                <div id="login-error" class="login-error"></div>
            </form>

            <div id="oidc-login" class="oidc-section" style="display: none;">
                <div class="login-divider"><span>or</span></div>
                <button id="oidc-login-btn" class="btn oidc-btn">
                    Login with SSO
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-btn-container header-left">
                <button id="settings-btn" class="header-btn header-btn-labeled" aria-label="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span>Settings</span>
                </button>
                <button id="header-theme-toggle" class="header-btn header-theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
                    <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
            <div class="header-title">
                <h1>Yarnl<span id="header-logo"><a href="#" id="mascot-home-link" style="text-decoration: none;"><img id="header-mascot-img" alt="Yarnl mascot" style="height: 2.59em; vertical-align: middle; margin-left: 0.3em;"><script>document.getElementById('header-mascot-img').src = localStorage.getItem('selectedMascot') || 'mascots/default.png';</script></a></span></h1>
                <p class="subtitle" id="header-tagline">Your self-hosted crochet companion</p>
            </div>
            <div class="header-btn-container header-right">
                <button id="add-pattern-btn" class="header-btn header-btn-labeled" aria-label="Add">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Add</span>
                </button>
                <div id="add-menu" class="add-menu" style="display: none;">
                    <button class="add-menu-item" id="add-upload-pdf">PDF</button>
                    <button class="add-menu-item" id="add-new-pattern">Markdown</button>
                    <button class="add-menu-item" id="add-new-project">Project</button>
                </div>
                <button id="header-logout-btn" class="header-btn" aria-label="Log out" title="Log out">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(180deg);">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="current">In Progress<span class="tab-count" id="current-tab-count"></span></button>
            <button class="tab-btn" data-tab="library">Library<span class="tab-count" id="library-tab-count"></span></button>
            <button class="tab-btn" data-tab="projects" id="projects-tab-btn">Projects<span class="tab-count" id="projects-tab-count"></span></button>
        </nav>

        <!-- Current Patterns Tab -->
        <div id="current" class="tab-content active">
            <div class="current-patterns-container">
                <div id="current-patterns-grid" class="patterns-grid">
                    <p class="empty-state">You don't have any active patterns. Time to start crocheting!</p>
                </div>
            </div>
        </div>

        <!-- Pattern Library Tab -->
        <div id="library" class="tab-content">
            <div class="patterns-container">
                <div class="mobile-filter-bar">
                    <button id="mobile-filter-btn" class="mobile-filter-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        Filters
                    </button>
                    <div class="mobile-search-inline">
                        <input type="text" id="mobile-search-input" placeholder="Search patterns...">
                    </div>
                </div>
                <div class="library-layout">
                    <aside class="library-sidebar">
                        <div class="sidebar-section">
                            <label for="search-input">Search</label>
                            <div class="search-input-wrapper">
                                <input type="text" id="search-input" placeholder="Search patterns...">
                                <button type="button" id="search-clear-btn" class="search-clear-btn" title="Clear search">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <label for="show-filter-select">Show</label>
                            <select id="show-filter-select">
                                <option value="all">All Patterns</option>
                                <option value="favorites">Favorites Only</option>
                                <option value="current">In Progress Only</option>
                                <option value="new">New Only</option>
                            </select>
                        </div>
                        <div class="sidebar-section">
                            <label for="category-filter-select">Category</label>
                            <select id="category-filter-select">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="sidebar-section">
                            <div class="sort-header">
                                <label for="sort-select">Sort by</label>
                                <div class="pin-buttons">
                                    <button id="pin-current" class="pin-btn" title="Pin current patterns to top">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </button>
                                    <button id="pin-favorites" class="pin-btn" title="Pin favorites to top">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <select id="sort-select">
                                <option value="date-desc">Date (Newest)</option>
                                <option value="date-asc">Date (Oldest)</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                        <div class="sidebar-section">
                            <label>Status</label>
                            <div class="sidebar-toggle-row">
                                <span>Completed</span>
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="show-completed" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="sidebar-toggle-row">
                                <span>In Progress</span>
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="show-current" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <label>Type</label>
                            <div class="sidebar-toggle-row">
                                <span>PDF</span>
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="show-pdf" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="sidebar-toggle-row">
                                <span>Markdown</span>
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="show-markdown" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <label>Highlight</label>
                            <select id="highlight-select" class="sidebar-select">
                                <option value="none">None</option>
                                <option value="favorites">Favorites</option>
                                <option value="current">In Progress</option>
                                <option value="new">New Patterns</option>
                            </select>
                        </div>
                    </aside>
                    <div id="patterns-grid" class="patterns-grid">
                        <p class="empty-state">No patterns yet. Upload your first pattern!</p>
                    </div>
                </div>
            </div>

            <!-- Upload Panel (hidden until needed) -->
            <div id="upload-panel" class="upload-panel" style="display: none;">
                <div class="upload-panel-header">
                    <button id="close-upload-panel" class="btn btn-secondary">‚Üê Back</button>
                    <h3>Upload Patterns</h3>
                </div>
                <div class="upload-container">
                    <div id="drop-zone" class="drop-zone">
                        <div class="drop-zone-content">
                            <span class="drop-zone-icon">üìÑ</span>
                            <p class="drop-zone-text">Drag & drop PDF files here or click to browse</p>
                            <p class="drop-zone-subtext">You can select multiple files at once</p>
                            <input type="file" id="file-input" accept=".pdf" multiple hidden>
                            <button type="button" id="browse-btn" class="btn btn-secondary">Browse Files</button>
                        </div>
                    </div>

                    <!-- Staging Area -->
                    <div id="staging-area" class="staging-area" style="display: none;">
                        <div class="staging-header">
                            <h3>Staged Files (<span id="staged-count">0</span>)</h3>
                            <button type="button" id="clear-all-btn" class="btn btn-secondary btn-sm">Clear All</button>
                        </div>
                        <div id="staged-files-list" class="staged-files-list">
                            <!-- Staged files will be added here -->
                        </div>
                        <div class="staging-footer">
                            <button type="button" id="upload-all-btn" class="btn btn-primary">Upload All</button>
                        </div>
                        <div id="completed-uploads" class="completed-uploads" style="display: none;">
                            <div class="completed-uploads-header">
                                <h4>Completed</h4>
                                <button type="button" id="clear-completed-btn" class="btn btn-secondary btn-sm">Clear</button>
                            </div>
                            <div id="completed-uploads-list" class="completed-uploads-list">
                                <!-- Completed uploads will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Pattern Panel (for markdown patterns) -->
            <div id="new-pattern-panel" class="new-pattern-panel" style="display: none;">
                <div class="new-pattern-header">
                    <button id="close-new-pattern-panel" class="btn btn-secondary">‚Üê Back</button>
                    <h3>Create New Pattern</h3>
                </div>
                <div class="new-pattern-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-pattern-name">Name <span class="required">required</span></label>
                            <input type="text" id="new-pattern-name" required placeholder="Enter pattern name">
                        </div>
                        <div class="form-group">
                            <label>Category <span class="required">required</span></label>
                            <div id="new-pattern-category-container">
                                <!-- Category dropdown will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-pattern-description">Description <span class="char-counter"><span id="new-desc-count">0</span>/45</span></label>
                        <input type="text" id="new-pattern-description" placeholder="Brief description (optional)" maxlength="45" oninput="document.getElementById('new-desc-count').textContent = this.value.length">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hashtags <span class="required">optional</span></label>
                            <div id="new-pattern-hashtags-container">
                                <!-- Hashtag selector will be populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Thumbnail <span class="required">optional</span></label>
                            <div class="thumbnail-selector" id="new-pattern-thumbnail-selector" data-target="new-pattern">
                                <div class="thumbnail-selector-preview" id="new-pattern-thumbnail-preview">
                                    <span class="thumbnail-selector-placeholder">+</span>
                                </div>
                            </div>
                            <small class="form-hint">Click to select or paste an image</small>
                        </div>
                    </div>
                    <div class="form-group new-pattern-content-group">
                        <div class="new-pattern-content-header">
                            <label>Pattern Content <span class="required">markdown</span></label>
                            <div class="new-pattern-tabs">
                                <button type="button" class="new-pattern-tab active" data-tab="edit">Edit</button>
                                <button type="button" class="new-pattern-tab" data-tab="preview">Preview</button>
                                <label class="new-pattern-live-preview-label">
                                    <input type="checkbox" id="new-pattern-live-preview">
                                    <span>Live preview</span>
                                </label>
                            </div>
                        </div>
                        <div class="new-pattern-editor-wrapper">
                            <textarea id="new-pattern-content" placeholder="Write your pattern here... Markdown supported!

Example:
# My Pattern

## Materials
- Yarn: Worsted weight
- Hook: 5mm

## Instructions
### Round 1
6 sc in magic ring (6)

### Round 2
Inc in each st around (12)
"></textarea>
                            <div id="new-pattern-preview" class="new-pattern-preview"></div>
                        </div>
                    </div>
                    <div class="new-pattern-actions">
                        <div class="mark-current-toggle">
                            <span class="mark-current-label">Mark as in progress</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="new-pattern-is-current">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <button type="button" id="cancel-new-pattern" class="btn btn-secondary">Cancel</button>
                        <button type="button" id="save-new-pattern" class="btn btn-primary">Create Pattern</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="projects-container">
                <div id="projects-grid" class="patterns-grid">
                    <p class="empty-state">You haven't created any projects yet. Projects let you group multiple patterns together for larger works!</p>
                </div>
            </div>
        </div>

        <!-- New Project Panel -->
        <div id="new-project-panel" class="new-pattern-panel" style="display: none;">
            <div class="new-pattern-header">
                <button id="close-new-project-panel" class="btn btn-secondary">‚Üê Back</button>
                <h3>Create New Project</h3>
            </div>
            <div class="new-pattern-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-project-name">Name <span class="required">required</span></label>
                        <input type="text" id="new-project-name" placeholder="Enter project name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-project-description">Description <span class="required">optional</span></label>
                        <input type="text" id="new-project-description" placeholder="Brief description">
                    </div>
                </div>
                <div class="form-group">
                    <label>Hashtags <span class="required">optional</span></label>
                    <div id="new-project-hashtags-container">
                        <!-- Hashtag selector will be populated dynamically -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Add Patterns <span class="required">optional</span></label>
                    <div class="project-add-patterns-tabs">
                        <button type="button" class="project-add-tab active" data-tab="existing">Add Existing</button>
                        <button type="button" class="project-add-tab" data-tab="import">Import New</button>
                    </div>

                    <!-- Tab 1: Add Existing Patterns -->
                    <div id="project-existing-tab" class="project-tab-content active">
                        <div class="project-existing-layout">
                            <aside class="project-existing-sidebar">
                                <div class="sidebar-section">
                                    <label>Search</label>
                                    <input type="text" id="project-existing-search-input" placeholder="Search patterns...">
                                </div>
                                <div class="sidebar-section">
                                    <label>Show</label>
                                    <select id="project-show-filter">
                                        <option value="all">All Patterns</option>
                                        <option value="favorites">Favorites Only</option>
                                        <option value="current">In Progress Only</option>
                                        <option value="new">New Only</option>
                                    </select>
                                </div>
                                <div class="sidebar-section">
                                    <label>Category</label>
                                    <select id="project-category-filter">
                                        <option value="all">All Categories</option>
                                    </select>
                                </div>
                                <div class="sidebar-section">
                                    <label>Sort by</label>
                                    <select id="project-sort-select">
                                        <option value="date-desc">Date (Newest)</option>
                                        <option value="date-asc">Date (Oldest)</option>
                                        <option value="name-asc">Name (A-Z)</option>
                                        <option value="name-desc">Name (Z-A)</option>
                                    </select>
                                </div>
                                <div class="sidebar-section">
                                    <label>Status</label>
                                    <div class="sidebar-toggle-row">
                                        <span>Completed</span>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" id="project-show-completed" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="sidebar-toggle-row">
                                        <span>In Progress</span>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" id="project-show-current" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="sidebar-section">
                                    <label>Type</label>
                                    <div class="sidebar-toggle-row">
                                        <span>PDF</span>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" id="project-show-pdf" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="sidebar-toggle-row">
                                        <span>Markdown</span>
                                        <label class="toggle-switch small">
                                            <input type="checkbox" id="project-show-markdown" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </aside>
                            <div class="project-existing-main">
                                <div class="project-existing-grid" id="project-existing-grid">
                                    <!-- Patterns will be rendered here -->
                                </div>
                                <div class="project-selected-count" id="project-selected-count" style="display: none;">
                                    <span id="project-selected-count-text">0 patterns selected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Import New PDFs -->
                    <div id="project-import-tab" class="project-tab-content" style="display: none;">
                        <div id="project-drop-zone" class="drop-zone project-drop-zone">
                            <div class="drop-zone-content">
                                <span class="drop-zone-icon">üìÅ</span>
                                <p class="drop-zone-text">Drag & drop PDF files here to add patterns</p>
                                <input type="file" id="project-file-input" accept=".pdf" multiple hidden>
                                <button type="button" id="project-browse-btn" class="btn btn-secondary">Browse Files</button>
                            </div>
                        </div>
                        <div id="project-staged-files" class="project-staged-files" style="display: none;">
                            <div class="staged-header">
                                <span>PDFs to import (<span id="project-staged-count">0</span>)</span>
                                <button type="button" id="project-clear-staged" class="btn btn-secondary btn-sm">Clear</button>
                            </div>
                            <div id="project-staged-list" class="project-staged-list"></div>
                        </div>
                    </div>
                </div>
                <div class="new-pattern-actions">
                    <button type="button" id="cancel-new-project" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="save-new-project" class="btn btn-primary">Create Project</button>
                </div>
            </div>
        </div>

        <!-- Project Detail View -->
        <div id="project-detail-view" class="project-detail-view" style="display: none;">
            <div class="project-detail-header">
                <button type="button" id="close-project-detail" class="btn btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back
                </button>
                <div class="project-detail-title">
                    <h2 id="project-detail-name">Project Name</h2>
                    <p id="project-detail-description" class="project-detail-description"></p>
                </div>
                <div class="project-detail-actions">
                    <button type="button" id="project-edit-btn" class="btn btn-secondary" title="Edit project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" id="project-notes-btn" class="btn btn-secondary" title="Project notes">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="project-detail-progress">
                <div class="progress-info">
                    <span id="project-progress-text">0/0 complete</span>
                    <span id="project-total-time">Total time: 0h 0m</span>
                </div>
                <div class="progress-bar">
                    <div id="project-progress-fill" class="progress-fill" style="width: 0%;"></div>
                </div>
            </div>
            <div class="project-detail-hashtags" id="project-detail-hashtags"></div>
            <div class="project-patterns-list" id="project-patterns-list">
                <!-- Patterns will be rendered here -->
            </div>
            <div class="project-detail-footer">
                <button type="button" id="add-patterns-to-project-btn" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Patterns
                </button>
                <button type="button" id="reorder-patterns-btn" class="btn btn-secondary" onclick="toggleProjectReorderMode()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                    Reorder
                </button>
            </div>
        </div>

        <!-- Add Patterns to Project Modal -->
        <div id="add-patterns-modal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Add Patterns to Project</h3>
                    <button type="button" class="modal-close" id="close-add-patterns-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="project-add-patterns-tabs">
                        <button type="button" class="project-add-tab active" data-tab="modal-existing" id="add-modal-existing-tab-btn">Add Existing</button>
                        <button type="button" class="project-add-tab" data-tab="modal-import" id="add-modal-import-tab-btn">Import New</button>
                    </div>

                    <!-- Tab 1: Add Existing Patterns -->
                    <div id="add-modal-existing-tab" class="project-tab-content active">
                        <div class="add-patterns-search">
                            <input type="text" id="add-patterns-search-input" placeholder="Search patterns...">
                        </div>
                        <div class="add-patterns-grid" id="add-patterns-grid">
                            <!-- Available patterns will be rendered here -->
                        </div>
                    </div>

                    <!-- Tab 2: Import New PDFs -->
                    <div id="add-modal-import-tab" class="project-tab-content" style="display: none;">
                        <div id="add-modal-drop-zone" class="drop-zone project-drop-zone">
                            <div class="drop-zone-content">
                                <span class="drop-zone-icon">üìÅ</span>
                                <p class="drop-zone-text">Drag & drop PDF files here to add patterns</p>
                                <input type="file" id="add-modal-file-input" accept=".pdf" multiple hidden>
                                <button type="button" id="add-modal-browse-btn" class="btn btn-secondary">Browse Files</button>
                            </div>
                        </div>
                        <div id="add-modal-staged-files" class="project-staged-files" style="display: none;">
                            <div class="staged-header">
                                <span>PDFs to import (<span id="add-modal-staged-count">0</span>)</span>
                                <button type="button" id="add-modal-clear-staged" class="btn btn-secondary btn-sm">Clear</button>
                            </div>
                            <div id="add-modal-staged-list" class="project-staged-list"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: flex-start;">
                    <button type="button" id="cancel-add-patterns" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="confirm-add-patterns" class="btn btn-primary">Add Selected</button>
                </div>
            </div>
        </div>

        <!-- Project Notes Modal -->
        <div id="project-notes-modal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Project Notes</h3>
                    <button type="button" class="modal-close" id="close-project-notes-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <textarea id="project-notes-textarea" class="notes-textarea" placeholder="Add notes about this project..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancel-project-notes" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="save-project-notes" class="btn btn-primary">Save Notes</button>
                </div>
            </div>
        </div>

        <!-- Edit Project Modal -->
        <div id="edit-project-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Project</h3>
                    <button type="button" class="modal-close" id="close-edit-project-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-project-name">Name <span class="required">required</span></label>
                        <input type="text" id="edit-project-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-project-description">Description <span class="required">optional</span></label>
                        <textarea id="edit-project-description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Hashtags <span class="required">optional</span></label>
                        <div id="edit-project-hashtag-selector" class="hashtag-selector"></div>
                    </div>
                    <div class="form-group">
                        <label>Thumbnail <span class="required">optional</span></label>
                        <div class="thumbnail-selector" id="edit-project-thumbnail-selector" data-target="edit-project">
                            <div class="thumbnail-selector-preview" id="edit-project-thumbnail-preview">
                                <span class="thumbnail-selector-placeholder">+</span>
                            </div>
                        </div>
                        <p class="help-text">Click to select or paste an image</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="delete-project-btn" class="btn btn-danger">Delete Project</button>
                    <button type="button" id="cancel-edit-project" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="save-edit-project" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="settings-layout">
                <!-- Settings Sidebar -->
                <nav class="settings-sidebar">
                    <div class="settings-search-wrapper">
                        <svg class="settings-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="settings-search-input" placeholder="Search settings...">
                        <button type="button" id="settings-search-clear" class="settings-search-clear" title="Clear search">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="settings-nav-scroll">
                    <button class="settings-nav-btn active" data-section="appearance">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                        </svg>
                        <span>Appearance</span>
                    </button>
                    <button class="settings-nav-btn" data-section="categories">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"></path>
                        </svg>
                        <span>Categories & Tags</span>
                    </button>
                    <button class="settings-nav-btn" data-section="shortcuts">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                            <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"></path>
                        </svg>
                        <span>Keyboard Shortcuts</span>
                    </button>
                    <button class="settings-nav-btn" data-section="backup">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Backup & Restore</span>
                    </button>
                    <button class="settings-nav-btn" data-section="notifications">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span>Notifications</span>
                    </button>
                    <button class="settings-nav-btn" data-section="about">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>About</span>
                    </button>
                    <button class="settings-nav-btn" data-section="account" id="account-nav-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span>Account</span>
                    </button>
                    <button class="settings-nav-btn" data-section="admin" id="admin-nav-btn" style="display: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <span>Admin</span>
                    </button>
                    <button class="settings-nav-btn" data-section="archive">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="21 8 21 21 3 21 3 8"></polyline>
                            <rect x="1" y="3" width="22" height="5"></rect>
                            <line x1="10" y1="12" x2="14" y2="12"></line>
                        </svg>
                        <span>Archive</span>
                    </button>
                    </div>
                </nav>

                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- No Results Message -->
                    <div class="settings-no-results" id="settings-no-results">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <p>No settings found matching your search</p>
                    </div>
                    <!-- Appearance Section -->
                    <section class="settings-section active" data-section="appearance">
                        <h3>Appearance</h3>
                        <p class="section-description">Customize the look and feel of your app</p>

                        <h4 class="settings-subheading">Theme</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Color Theme</label>
                                <p class="setting-description">Choose a color scheme</p>
                            </div>
                            <select id="theme-select" class="settings-select">
                                <option value="lavender">Lavender</option>
                                <option value="ocean">Ocean</option>
                                <option value="forest">Forest</option>
                                <option value="sunset">Sunset</option>
                                <option value="rose">Rose</option>
                                <option value="slate">Slate</option>
                                <option value="aqua">Aqua</option>
                                <option value="midnight">Midnight</option>
                                <option value="razer">Razer</option>
                                <option value="synthwave">Synthwave</option>
                                <option value="cyberpunk">Cyberpunk</option>
                                <option value="dracula">Dracula</option>
                                <option value="coffee">Coffee</option>
                                <option value="nasa">NASA</option>
                                <option value="minimal">Minimal</option>
                                <option value="halloween">Halloween</option>
                                <option value="nuked">Nuked</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Party Mode</label>
                                <p class="setting-description">Random theme & font combo</p>
                            </div>
                            <button id="party-mode-btn" class="party-mode-btn" title="Randomize theme and font">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                Surprise Me!
                            </button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Day / Night Mode</label>
                                <p class="setting-description">Switch between light and dark</p>
                            </div>
                            <div class="day-night-toggle">
                                <button type="button" id="day-mode-btn" class="mode-btn" title="Day Mode">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="5"/>
                                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                                    </svg>
                                </button>
                                <button type="button" id="night-mode-btn" class="mode-btn" title="Night Mode">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Auto Switch</label>
                                <p class="setting-description">Automatically change mode</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-mode-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item" id="auto-type-container" style="display: none;">
                            <div class="setting-info">
                                <label>Auto Type</label>
                                <p class="setting-description">System preference or scheduled</p>
                            </div>
                            <select id="auto-type-select" class="settings-select">
                                <option value="system">System</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                        <div class="setting-item" id="schedule-times-container" style="display: none;">
                            <div class="setting-info">
                                <label>Schedule Times</label>
                                <p class="setting-description">Day starts / Night starts</p>
                            </div>
                            <div class="schedule-times">
                                <input type="time" id="day-start-time" value="07:00">
                                <span class="schedule-separator">/</span>
                                <input type="time" id="night-start-time" value="19:00">
                            </div>
                        </div>

                        <h4 class="settings-subheading">Font</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Font Family</label>
                                <p class="setting-description">Choose your preferred font</p>
                            </div>
                            <select id="font-select" class="settings-select">
                                <option value="JetBrains Mono">JetBrains Mono (Default)</option>
                                <option value="Inter">Inter</option>
                                <option value="Roboto">Roboto</option>
                                <option value="Open Sans">Open Sans</option>
                                <option value="Lato">Lato</option>
                                <option value="Poppins">Poppins</option>
                                <option value="Nunito">Nunito</option>
                                <option value="Raleway">Raleway</option>
                                <option value="Source Sans Pro">Source Sans Pro</option>
                                <option value="Ubuntu">Ubuntu</option>
                                <option value="Fira Sans">Fira Sans</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="setting-item" id="custom-font-container" style="display: none;">
                            <div class="setting-info">
                                <label>Google Font name</label>
                                <p class="setting-description">Enter exact name from <a href="https://fonts.google.com" target="_blank">Google Fonts</a></p>
                            </div>
                            <div class="custom-font-input-row">
                                <input type="text" id="custom-font-input" class="settings-input" placeholder="e.g., Lato, Raleway, etc.">
                                <button id="apply-custom-font-btn" class="btn btn-primary">Apply</button>
                            </div>
                        </div>

                        <h4 class="settings-subheading">Header</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Gradient Header</label>
                                <p class="setting-description">Use gradient colors</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="gradient-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Theme Toggle</label>
                                <p class="setting-description">Show day/night button in header</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show-header-theme-toggle-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Show Logo</label>
                                <p class="setting-description">Display mascot in header</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show-logo-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item" id="mascot-selector-container">
                            <div class="setting-info">
                                <label>Mascot</label>
                                <p class="setting-description">Choose header mascot</p>
                            </div>
                            <button id="mascot-select-btn" class="settings-select"><span id="current-mascot-name">Default</span></button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Theme Mascot</label>
                                <p class="setting-description">Use matching mascot for theme</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="theme-mascot-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Show Tagline</label>
                                <p class="setting-description">Display subtitle text</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="show-tagline-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item" id="tagline-input-container">
                            <div class="setting-info">
                                <label>Tagline Text</label>
                                <p class="setting-description">Customize subtitle</p>
                            </div>
                            <input type="text" id="tagline-input" class="settings-input" placeholder="Your self-hosted crochet companion">
                        </div>

                        <h4 class="settings-subheading">Mobile</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Haptic Feedback</label>
                                <p class="setting-description">Vibrate on mobile button taps</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="haptic-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <h4 class="settings-subheading">Library</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Default Page</label>
                                <p class="setting-description">Page shown on startup</p>
                            </div>
                            <select id="default-page-select" class="settings-select">
                                <option value="current">In Progress</option>
                                <option value="library">Library</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Tab Counts</label>
                                <p class="setting-description">Show pattern counts on tabs</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="tab-counts-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Auto In-Progress on Timer</label>
                                <p class="setting-description">Mark pattern as in progress when timer starts</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-current-timer-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <h4 class="settings-subheading">Badge Visibility</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Type Badge</label>
                                <p class="setting-description">Show PDF/MD on cards</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="badge-type-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Status Badge</label>
                                <p class="setting-description">Show CURRENT/COMPLETE on cards</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="badge-status-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Category Badge</label>
                                <p class="setting-description">Show category on cards</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="badge-category-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Star Badge</label>
                                <p class="setting-description">Show star on favorite cards</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="badge-star-checkbox" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <h4 class="settings-subheading">Pattern Viewer</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Default Zoom</label>
                                <p class="setting-description">Initial zoom level for PDFs</p>
                            </div>
                            <select id="default-zoom-select" class="settings-select">
                                <option value="fit">Fit Page</option>
                                <option value="fit-width">Fit Width</option>
                                <option value="25">25%</option>
                                <option value="50">50%</option>
                                <option value="75">75%</option>
                                <option value="100">100%</option>
                                <option value="125">125%</option>
                                <option value="150">150%</option>
                                <option value="175">175%</option>
                                <option value="200">200%</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Page Mode</label>
                                <p class="setting-description">How pages are displayed in the viewer</p>
                            </div>
                            <select id="pdf-scroll-mode-select" class="settings-select">
                                <option value="page">Paginated</option>
                                <option value="scroll">Scroll</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Auto Timer</label>
                                <p class="setting-description">Enable auto timer by default</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-timer-default-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="settings-reset">
                            <button id="reset-appearance-btn" class="btn btn-secondary">Reset to Defaults</button>
                        </div>
                    </section>

                    <!-- Categories & Tags Section -->
                    <section class="settings-section" data-section="categories">
                        <h3>Categories & Tags</h3>
                        <p class="section-description">Organize your pattern library</p>

                        <h4 class="settings-subheading">Categories</h4>
                        <div class="categories-list" id="categories-list">
                            <!-- Categories will be populated here -->
                        </div>
                        <div class="add-category-form">
                            <input type="text" id="new-category-input" placeholder="New category name...">
                            <button id="add-category-btn" class="btn btn-primary">Add</button>
                        </div>

                        <h4 class="settings-subheading">Hashtags</h4>
                        <div class="hashtags-list" id="hashtags-list">
                            <!-- Hashtags will be populated here -->
                        </div>
                        <div class="add-hashtag-form">
                            <input type="text" id="new-hashtag-input" placeholder="New hashtag...">
                            <button id="add-hashtag-btn" class="btn btn-primary">Add</button>
                        </div>
                    </section>

                    <!-- Keyboard Shortcuts Section -->
                    <section class="settings-section" data-section="shortcuts">
                        <h3>Keyboard Shortcuts</h3>
                        <p class="section-description">Customize keyboard shortcuts for the PDF viewer. <a href="https://yarnl.com/docs/guide/keyboard-shortcuts" target="_blank" rel="noopener noreferrer">Learn more</a></p>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="media-remote-enabled">Bluetooth/Media Remote</label>
                                <p class="setting-description">Enable to use media keys (play/pause, next, prev) from a Bluetooth remote. Requires Yarnl to be the active media app.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="media-remote-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label for="arrow-keys-scroll">Arrow Keys Scroll PDF</label>
                                <p class="setting-description">When enabled, arrow keys scroll the PDF. When disabled, they control counters and page navigation.</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="arrow-keys-scroll">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Increase Counter</label>
                                <p class="setting-description">Add one to selected counter</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="counterIncrease" data-index="0" title="Click to change">‚Üë</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="counterIncrease" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="counterIncrease" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Decrease Counter</label>
                                <p class="setting-description">Subtract one from selected counter</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="counterDecrease" data-index="0" title="Click to change">‚Üì</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="counterDecrease" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="counterDecrease" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Previous Page</label>
                                <p class="setting-description">Go back one page</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="prevPage" data-index="0" title="Click to change">‚Üê</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="prevPage" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="prevPage" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Next Page</label>
                                <p class="setting-description">Go forward one page</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="nextPage" data-index="0" title="Click to change">‚Üí</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="nextPage" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="nextPage" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Start/Stop Timer</label>
                                <p class="setting-description">Toggle project timer</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="toggleTimer" data-index="0" title="Click to change">Space</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="toggleTimer" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="toggleTimer" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Next Counter</label>
                                <p class="setting-description">Cycle to next counter</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="nextCounter" data-index="0" title="Click to change">Tab</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="nextCounter" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="nextCounter" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Zoom In</label>
                                <p class="setting-description">Increase PDF zoom</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="zoomIn" data-index="0" title="Click to change">+</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="zoomIn" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="zoomIn" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Zoom Out</label>
                                <p class="setting-description">Decrease PDF zoom</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="zoomOut" data-index="0" title="Click to change">‚àí</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="zoomOut" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="zoomOut" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <div class="setting-item shortcut-item">
                            <div class="setting-info">
                                <label>Exit Viewer</label>
                                <p class="setting-description">Close and return to library</p>
                            </div>
                            <div class="shortcut-keys">
                                <button class="shortcut-key-btn" data-shortcut="exitViewer" data-index="0" title="Click to change">Esc</button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="exitViewer" data-index="1" title="Click to add alternate key"></button>
                                <button class="shortcut-key-btn shortcut-alt" data-shortcut="exitViewer" data-index="2" title="Click to add alternate key"></button>
                            </div>
                        </div>
                        <button id="reset-shortcuts-btn" class="btn btn-secondary" style="margin-top: 12px;">Reset to Defaults</button>
                    </section>

                    <!-- Backup Section -->
                    <section class="settings-section" data-section="backup">
                        <h3>Backup & Restore</h3>
                        <p class="section-description">Create and manage backups of your patterns, settings, and data</p>

                        <div class="warning-banner">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>This feature is experimental. Always keep additional copies of important patterns.</span>
                        </div>

                        <div class="backup-create-section">
                            <button id="create-backup-btn" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Create Backup
                            </button>
                        </div>

                        <h4 class="settings-subheading">Backup Options</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Include PDF Patterns</label>
                                <p class="setting-description" id="pdf-size-info">Loading size...</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-include-patterns" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Include Markdown Patterns</label>
                                <p class="setting-description" id="markdown-size-info">Loading size...</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-include-markdown" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Include Archive</label>
                                <p class="setting-description" id="archive-size-info">Loading archive size...</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-include-archive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Include Notes</label>
                                <p class="setting-description" id="notes-size-info">Loading notes size...</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-include-notes" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="backup-estimate" id="backup-estimate">Estimated backup size: calculating...</p>

                        <h4 class="settings-subheading">Schedule</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Scheduled Backups</label>
                                <p class="setting-description">Automatically create backups</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-schedule-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="backup-schedule-options" style="display: none;">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Frequency</label>
                                    <p class="setting-description">How often to backup</p>
                                </div>
                                <select id="backup-schedule-select" class="settings-select">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Time</label>
                                    <p class="setting-description">When to run backups (24h, local time)</p>
                                </div>
                                <input type="time" id="backup-time-input" class="settings-input" value="03:00">
                            </div>
                        </div>

                        <h4 class="settings-subheading">Cleanup</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Auto Cleanup</label>
                                <p class="setting-description">Automatically delete old backups</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="backup-prune-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="backup-prune-options" style="display: none;">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Delete by</label>
                                    <p class="setting-description">How to determine which backups to delete</p>
                                </div>
                                <select id="backup-prune-mode" class="settings-select">
                                    <option value="keep">Number of backups</option>
                                    <option value="days">Age of backup</option>
                                </select>
                            </div>
                            <div class="setting-item" id="prune-keep-container">
                                <div class="setting-info">
                                    <label>Keep last</label>
                                    <p class="setting-description">Delete backups beyond this count</p>
                                </div>
                                <div class="input-with-suffix">
                                    <input type="number" id="backup-prune-value" class="settings-input" value="5" min="1" max="999">
                                    <span class="input-suffix">backups</span>
                                </div>
                            </div>
                            <div class="setting-item" id="prune-age-container" style="display: none;">
                                <div class="setting-info">
                                    <label>Older than</label>
                                    <p class="setting-description">Delete backups older than this</p>
                                </div>
                                <div class="input-with-select">
                                    <input type="number" id="backup-prune-age-value" class="settings-input" value="30" min="1" max="999">
                                    <select id="backup-prune-age-unit" class="settings-select">
                                        <option value="days">days</option>
                                        <option value="weeks">weeks</option>
                                        <option value="months">months</option>
                                        <option value="years">years</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Backup Section (Admin Only) -->
                        <hr id="admin-backup-divider" class="settings-divider" style="display: none;">
                        <div id="admin-backup-section" style="display: none;">
                            <h4 class="settings-subheading">Admin Backup</h4>
                            <details class="collapsible-card no-card-style">
                                <summary class="collapsible-card-header">
                                    <div class="collapsible-card-title">
                                        <span>Admin Configuration & User Data</span>
                                        <span class="collapsible-card-subtitle">Backup and restore admin panel configuration and all data for all users</span>
                                    </div>
                                    <svg class="collapsible-card-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                </summary>
                                <div class="collapsible-card-body">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <label>Admin Configuration Backup</label>
                                            <p class="setting-description">Backs up users, SSO, default categories, and admin settings</p>
                                        </div>
                                        <button id="admin-backup-config-btn" class="btn btn-secondary">Download Config</button>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <label>Restore Admin Configuration</label>
                                            <p class="setting-description">Restore users, SSO, default categories, and admin settings</p>
                                        </div>
                                        <input type="file" id="admin-restore-config-input" accept=".json" style="display: none;">
                                        <button id="admin-restore-config-btn" class="btn btn-secondary">Restore Config</button>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <label>User Data Backup</label>
                                            <p class="setting-description">Backs up data for all users: patterns, images, notes, archive</p>
                                        </div>
                                        <button id="admin-backup-data-btn" class="btn btn-secondary">Download Data</button>
                                    </div>
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <label>Restore User Data</label>
                                            <p class="setting-description">Restore all user files from backup</p>
                                        </div>
                                        <input type="file" id="admin-restore-data-input" accept=".zip" style="display: none;">
                                        <button id="admin-restore-data-btn" class="btn btn-secondary">Restore Data</button>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <h4 class="settings-subheading">Saved Backups</h4>
                        <div class="backups-list" id="backups-list">
                            <p class="no-backups">Loading backups...</p>
                        </div>
                        <p class="backup-location">Backups are saved to <code id="backup-path-display">./backups</code></p>
                    </section>


                    <!-- Archive Section -->
                    <section class="settings-section" data-section="archive">
                        <h3>Archive</h3>
                        <p class="section-description">Manage archived patterns</p>

                        <h4 class="settings-subheading">Behavior</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Delete instead of archive</label>
                                <p class="setting-description">Disables archive and replaces archive button with delete button that permanently deletes files</p>
                                <p class="setting-description" id="delete-mode-warning" style="display: none; font-style: italic;">Enabling will permanently delete all archived patterns</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable-delete-checkbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div id="archive-settings-section">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Auto Empty</label>
                                    <p class="setting-description">Automatically delete archived patterns after a set time</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-delete-checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-item" id="auto-delete-days-setting" style="display: none;">
                                <div class="setting-info">
                                    <label>Empty After</label>
                                    <p class="setting-description">Days before archived patterns are permanently deleted</p>
                                </div>
                                <div class="setting-input-group">
                                    <input type="number" id="auto-delete-days" class="settings-input" min="1" max="365" value="30" style="width: 70px;">
                                    <span class="setting-hint">days</span>
                                </div>
                            </div>
                        </div>

                        <div id="archived-patterns-section">
                            <h4 class="settings-subheading">Archived Patterns</h4>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label><span id="archived-patterns-count">0 archived patterns</span></label>
                                </div>
                                <button id="delete-all-archived-btn" class="btn btn-danger" style="display: none;">
                                    Delete All
                                </button>
                            </div>

                            <div class="archived-patterns-list" id="archived-patterns-list">
                                <p class="no-archived">Loading...</p>
                            </div>
                        </div>

                        <div id="archived-projects-section">
                            <h4 class="settings-subheading">Archived Projects</h4>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label><span id="archived-projects-count">0 archived projects</span></label>
                                </div>
                                <button id="delete-all-archived-projects-btn" class="btn btn-danger" style="display: none;">
                                    Delete All
                                </button>
                            </div>

                            <div class="archived-patterns-list" id="archived-projects-list">
                                <p class="no-archived">Loading...</p>
                            </div>
                        </div>
                    </section>

                    <!-- Notifications Section -->
                    <section class="settings-section" data-section="notifications">
                        <h3>Notifications</h3>
                        <p class="section-description">Configure push notifications for app events</p>

                        <h4 class="settings-subheading">Pushover</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Enable Pushover</label>
                                <p class="setting-description">Send notifications to your device</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pushover-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="pushover-settings" style="display: none;">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>User Key</label>
                                    <p class="setting-description">Your Pushover user key</p>
                                </div>
                                <input type="password" id="pushover-user-key" class="settings-input" placeholder="Enter user key">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>API Token</label>
                                    <p class="setting-description">Your Pushover API token</p>
                                </div>
                                <input type="password" id="pushover-app-token" class="settings-input" placeholder="Enter app token">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Test Connection</label>
                                    <p class="setting-description">Send a test notification</p>
                                </div>
                                <button id="pushover-test-btn" class="btn btn-secondary">Send Test</button>
                            </div>
                        </div>

                        <h4 class="settings-subheading">Events</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Backup Complete</label>
                                <p class="setting-description">Notify when backups finish</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-backup-complete" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Backup Errors</label>
                                <p class="setting-description">Notify when backups fail</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-backup-error" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Archive Emptied</label>
                                <p class="setting-description">Notify when archived patterns are auto-deleted</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notify-auto-delete" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </section>

                    <!-- About Section -->
                    <section class="settings-section" data-section="about">
                        <h3>About Yarnl</h3>
                        <p class="section-description">Crochet pattern management app</p>

                        <h4 class="settings-subheading">Library Stats</h4>
                        <div class="library-stats" id="library-stats">
                            <!-- Stats will be populated here -->
                        </div>

                        <h4 class="settings-subheading">App Info</h4>
                        <div class="about-info">
                            <p><strong>Version:</strong> 0.5.0</p>
                            <p><strong>Made with:</strong> Node.js, Express, PostgreSQL</p>
                        </div>

                        <h4 class="settings-subheading">Links</h4>
                        <div class="about-links">
                            <a href="https://github.com/titandrive/yarnl" target="_blank" rel="noopener noreferrer" class="about-link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                GitHub
                            </a>
                            <a href="https://yarnl.com" target="_blank" rel="noopener noreferrer" class="about-link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                Website
                            </a>
                            <a href="https://yarnl.com/docs/category/user-guide" target="_blank" rel="noopener noreferrer" class="about-link">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                </svg>
                                Docs
                            </a>
                        </div>
                    </section>

                    <!-- Admin Section (Admin Only) -->
                    <section class="settings-section" data-section="admin" id="admin-section">
                        <h3>Admin</h3>
                        <p class="section-description">Manage users, authentication, and system settings</p>

                        <h4 class="settings-subheading">User Management</h4>
                        <div id="users-list" class="users-list">
                            <!-- Users will be populated here -->
                        </div>

                        <button id="add-user-open-btn" class="btn btn-secondary" onclick="openAddUserModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add User
                        </button>

                        <hr class="settings-divider">

                        <details class="collapsible-card no-card-style">
                            <summary class="collapsible-card-header">
                                <div class="collapsible-card-title">
                                    <span>Default Categories</span>
                                    <span class="collapsible-card-subtitle">Categories that new users will start with</span>
                                </div>
                                <svg class="collapsible-card-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                            </summary>
                            <div class="collapsible-card-body">
                                <div class="categories-list" id="default-categories-list">
                                    <!-- Default categories will be populated here -->
                                </div>
                                <div class="add-category-form">
                                    <input type="text" id="new-default-category-input" placeholder="New default category...">
                                    <button id="add-default-category-btn" class="btn btn-primary">Add</button>
                                </div>
                            </div>
                        </details>

                        <h4 class="settings-subheading">OIDC / Single Sign-On</h4>
                        <p class="setting-description" style="margin-bottom: 1rem;">Configure authentication via your chosen OIDC provider such as PocketID or Authelia</p>

                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Enable OIDC</label>
                                <p class="setting-description">Allow users to login with SSO</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="oidc-enabled-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div id="oidc-config-fields" style="display: none;">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Callback URL</label>
                                    <p class="setting-description">Click to copy</p>
                                </div>
                                <span id="oidc-callback-url" class="copyable-url" onclick="copyCallbackUrl()"></span>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-issuer">Issuer URL</label>
                                    <p class="setting-description">Enter URL and click Discover</p>
                                </div>
                                <div class="discover-input-group">
                                    <input type="url" id="oidc-issuer" class="settings-input settings-input-wide" placeholder="https://auth.example.com">
                                    <button type="button" id="oidc-discover-btn" class="btn btn-secondary">Discover</button>
                                </div>
                            </div>
                            <div id="oidc-discovery-status" class="discovery-status" style="display: none;"></div>
                            <div id="oidc-discovered-endpoints" class="discovered-endpoints" style="display: none;">
                                <details>
                                    <summary>Discovered Endpoints</summary>
                                    <div class="endpoints-list">
                                        <div class="endpoint-item">
                                            <label>Authorization</label>
                                            <code id="oidc-auth-endpoint">-</code>
                                        </div>
                                        <div class="endpoint-item">
                                            <label>Token</label>
                                            <code id="oidc-token-endpoint">-</code>
                                        </div>
                                        <div class="endpoint-item">
                                            <label>User Info</label>
                                            <code id="oidc-userinfo-endpoint">-</code>
                                        </div>
                                        <div class="endpoint-item">
                                            <label>JWKS</label>
                                            <code id="oidc-jwks-endpoint">-</code>
                                        </div>
                                        <div class="endpoint-item">
                                            <label>Logout</label>
                                            <code id="oidc-logout-endpoint">-</code>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-client-id">Client ID</label>
                                </div>
                                <input type="text" id="oidc-client-id" class="settings-input settings-input-wide" placeholder="Client ID">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-client-secret">Client Secret</label>
                                </div>
                                <input type="password" id="oidc-client-secret" class="settings-input settings-input-wide" placeholder="Client Secret">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-provider-name">Provider Name</label>
                                    <p class="setting-description">Name to show on login button (e.g., "PocketID")</p>
                                </div>
                                <input type="text" id="oidc-provider-name" class="settings-input settings-input-wide" placeholder="SSO">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-icon-url">Provider Icon</label>
                                    <p class="setting-description"><a href="https://dashboardicons.com/" target="_blank">Icon</a> to show on login button (optional)</p>
                                </div>
                                <input type="text" id="oidc-icon-url" class="settings-input settings-input-wide" placeholder="https://example.com/icon.png">
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Disable local login</label>
                                    <p class="setting-description" id="oidc-disable-local-desc">Only allow login via SSO</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="oidc-disable-local">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label>Auto-create users</label>
                                    <p class="setting-description">Create accounts for new OIDC users</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="oidc-auto-create" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <label for="oidc-default-role">Default role for new users</label>
                                </div>
                                <select id="oidc-default-role" class="settings-select">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="oidc-actions">
                                <button id="save-oidc-btn" class="btn btn-primary">Save OIDC Settings</button>
                                <button id="reset-oidc-btn" class="btn btn-primary">Reset OIDC</button>
                            </div>
                        </div>
                    </section>

                    <!-- Account Section (All Users) -->
                    <section class="settings-section" data-section="account" id="account-section">
                        <h3>Account</h3>
                        <p class="section-description">Manage your account settings</p>

                        <h4 class="settings-subheading">Profile</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Logged in as</label>
                                <p class="setting-description" id="current-user-info">-</p>
                            </div>
                        </div>
                        <div class="setting-item" id="change-username-item" style="display: none;">
                            <div class="setting-info">
                                <label>Change Username</label>
                                <p class="setting-description">Update your login username</p>
                            </div>
                            <input type="text" id="account-username" class="settings-input" placeholder="New username">
                            <button id="save-username-btn" class="btn btn-secondary">Save</button>
                        </div>

                        <h4 class="settings-subheading" id="password-section-heading">Password</h4>
                        <div class="setting-item" id="password-setting-item">
                            <div class="setting-info">
                                <label>Current Password</label>
                                <p class="setting-description" id="password-status">-</p>
                            </div>
                        </div>
                        <div class="setting-item" id="change-password-item">
                            <div class="setting-info">
                                <label>Change Password</label>
                                <p class="setting-description">Set a new password for your account</p>
                            </div>
                            <button id="change-password-btn" class="btn btn-secondary">Change Password</button>
                            <div id="change-password-form" class="inline-form" style="display: none;">
                                <input type="password" id="current-password-input" placeholder="Current password (if any)" autocomplete="current-password">
                                <input type="password" id="new-password-input" placeholder="New password" autocomplete="new-password">
                                <input type="password" id="confirm-password-input" placeholder="Confirm new password" autocomplete="new-password">
                                <div class="inline-form-actions">
                                    <button id="save-password-btn" class="btn btn-primary">Save</button>
                                    <button id="cancel-password-btn" class="btn btn-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <div class="setting-item" id="remove-password-item" style="display: none;">
                            <div class="setting-info">
                                <label>Remove Password</label>
                                <p class="setting-description">Allow passwordless login</p>
                            </div>
                            <button id="remove-password-btn" class="btn btn-secondary">Remove Password</button>
                            <div id="remove-password-form" class="inline-form" style="display: none;">
                                <input type="password" id="remove-password-input" placeholder="Enter current password to confirm" autocomplete="current-password">
                                <div class="inline-form-actions">
                                    <button id="confirm-remove-password-btn" class="btn btn-primary">Remove</button>
                                    <button id="cancel-remove-password-btn" class="btn btn-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <h4 class="settings-subheading" id="sso-section-heading" style="display: none;">Single Sign-On</h4>
                        <div class="setting-item" id="sso-link-setting-item" style="display: none;">
                            <div class="setting-info">
                                <label>SSO Account</label>
                                <p class="setting-description" id="sso-link-status">Not linked</p>
                            </div>
                            <button id="link-sso-btn" class="btn btn-secondary">Link SSO Account</button>
                            <button id="unlink-sso-btn" class="btn btn-secondary" style="display: none;">Unlink</button>
                        </div>

                        <h4 class="settings-subheading">Session</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <label>Log Out</label>
                                <p class="setting-description">End your current session</p>
                            </div>
                            <button id="logout-btn" class="btn btn-secondary">Log Out</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- PDF Viewer with Counter Overlay (hidden by default, shown when clicking a pattern) -->
        <div id="pdf-viewer-container" class="pdf-viewer-container" style="display: none;">
            <div class="pdf-header">
                <div class="pdf-header-left">
                    <button id="pdf-back-btn" class="btn btn-secondary">‚Üê Back</button>
                    <button id="pdf-notes-btn" class="btn btn-secondary">Notes</button>
                    <button id="pdf-edit-btn" class="btn btn-secondary">Edit</button>
                    <button id="pdf-info-btn" class="btn btn-secondary">Info</button>
                </div>
                <h2 id="pdf-pattern-name"></h2>
                <div class="pdf-header-right">
                    <div class="timer-control">
                        <label class="auto-timer-toggle" title="Auto timer: runs while viewing, pauses on inactivity">
                            <input type="checkbox" id="pdf-auto-timer-checkbox">
                            <span class="auto-timer-slider"></span>
                            <span class="auto-timer-label">Auto</span>
                        </label>
                        <button id="pdf-timer-btn" class="btn btn-secondary timer-btn">
                            <svg class="timer-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span id="pdf-timer-display">0:00:00</span>
                        </button>
                        <button id="pdf-timer-reset-btn" class="timer-reset-btn" title="Reset timer">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="pdf-nav-controls">
                        <button id="prev-page-btn" class="btn btn-secondary">‚Üê</button>
                        <span id="page-info">Page 1 of 1</span>
                        <button id="next-page-btn" class="btn btn-secondary">‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Mobile Top Bar (visible only on mobile) -->
            <div class="mobile-top-bar">
                <button id="mobile-back-btn" class="mobile-top-btn" title="Back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span id="mobile-pattern-name" class="mobile-pattern-name"></span>
                <span class="mobile-page-info">1 / 1</span>
                <div class="mobile-top-right">
                    <button id="mobile-timer-btn" class="mobile-top-btn mobile-timer-btn" title="Toggle timer">
                        <svg class="timer-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="mobile-timer-display">0:00:00</span>
                    </button>
                    <div class="mobile-menu-wrapper">
                    <button id="mobile-menu-btn" class="mobile-top-btn" title="Menu">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="5" r="1.5" fill="currentColor" stroke="none"></circle>
                            <circle cx="12" cy="12" r="1.5" fill="currentColor" stroke="none"></circle>
                            <circle cx="12" cy="19" r="1.5" fill="currentColor" stroke="none"></circle>
                        </svg>
                    </button>
                    <div id="mobile-menu" class="mobile-menu" style="display: none;">
                        <button class="mobile-menu-item" id="mobile-notes-btn">Notes</button>
                        <button class="mobile-menu-item" id="mobile-edit-btn">Edit</button>
                        <button class="mobile-menu-item" id="mobile-info-btn">Info</button>
                        <div class="mobile-menu-divider"></div>
                        <label class="mobile-menu-item mobile-menu-toggle">
                            <span>Auto Timer</span>
                            <input type="checkbox" id="mobile-auto-timer-checkbox">
                            <span class="auto-timer-slider"></span>
                        </label>
                        <button class="mobile-menu-item mobile-menu-danger" id="mobile-timer-reset-btn">Reset Timer</button>
                    </div>
                    </div>
                </div>
            </div>

            <div class="pdf-viewer-wrapper">
                <div class="pdf-page-container">
                    <canvas id="pdf-canvas"></canvas>
                    <div id="pdf-annotation-layer" class="pdf-annotation-layer"></div>
                </div>
                <div class="pdf-scroll-spacer"></div>

                <!-- Floating Zoom Controls -->
                <div class="pdf-zoom-overlay">
                    <button id="zoom-fit-btn" class="zoom-btn zoom-fit" title="Fit page to view">Fit</button>
                    <button id="zoom-out-btn" class="zoom-btn" title="Zoom out">‚àí</button>
                    <input type="text" id="zoom-level" value="Fit" title="Enter zoom percentage">
                    <button id="zoom-in-btn" class="zoom-btn" title="Zoom in">+</button>
                    <button id="zoom-100-btn" class="zoom-btn zoom-fit" title="Fit width to screen">Zoom</button>
                </div>
            </div>

            <!-- Shared Counter Overlay at Bottom -->
            <div id="shared-counter-overlay" class="counter-overlay">
                <div id="counters-list" class="counters-list">
                    <!-- Counters will be dynamically added here -->
                </div>
                <div class="counter-actions">
                    <button id="add-counter-btn" class="btn btn-success">+</button>
                </div>
            </div>

            <!-- Mobile Bottom Bar (visible only on mobile) -->
            <div id="mobile-bottom-bar" class="mobile-bottom-bar">
                <button class="mobile-bar-btn mobile-page-prev" title="Previous page">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="mobile-bar-btn mobile-counter-add" style="display:none" title="Add counter">+</button>
                <div class="mobile-bar-counter">
                    <button class="mobile-bar-nav mobile-counter-prev">‚Äπ</button>
                    <div class="mobile-bar-btn mobile-counter-dec">‚àí</div>
                    <div class="mobile-bar-counter-label">
                        <span class="mobile-counter-name">Counter</span>
                        <span class="mobile-counter-value">0</span>
                    </div>
                    <div class="mobile-bar-btn mobile-counter-inc">+</div>
                    <button class="mobile-bar-nav mobile-counter-next">‚Ä∫</button>
                </div>
                <button class="mobile-bar-btn mobile-page-next" title="Next page">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 6 15 12 9 18"></polyline>
                    </svg>
                </button>
                <!-- Counter Edit Panel (slides up) -->
                <div class="mobile-bar-edit" style="display: none;">
                    <div class="mobile-bar-edit-row">
                        <button class="mobile-bar-edit-nav mobile-edit-prev">‚Äπ</button>
                        <span class="mobile-edit-pos">1 / 1</span>
                        <button class="mobile-bar-edit-nav mobile-edit-next">‚Ä∫</button>
                    </div>
                    <input type="text" class="mobile-edit-name" placeholder="Counter name">
                    <div class="mobile-bar-edit-actions">
                        <button class="mobile-bar-edit-btn mobile-edit-done">Done</button>
                        <button class="mobile-bar-edit-btn mobile-edit-add">Add</button>
                        <button class="mobile-bar-edit-btn mobile-bar-edit-btn-small mobile-edit-reset">Reset</button>
                        <button class="mobile-bar-edit-btn mobile-bar-edit-btn-small mobile-edit-delete">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Notes Popover -->
            <div id="notes-popover" class="notes-popover" style="display: none;">
                <div class="notes-popover-header">
                    <div class="notes-tabs">
                        <button class="notes-tab active" data-tab="edit">Edit</button>
                        <button class="notes-tab" data-tab="preview">Preview</button>
                    </div>
                    <button id="notes-close-btn" class="notes-close">&times;</button>
                </div>
                <div class="notes-popover-body">
                    <textarea id="notes-editor" placeholder="Write your notes here... Markdown supported!"></textarea>
                    <div id="notes-preview" class="notes-preview" style="display: none;"></div>
                </div>
                <div class="notes-popover-footer">
                    <label class="notes-live-preview-label">
                        <input type="checkbox" id="notes-live-preview">
                        <span>Live preview</span>
                    </label>
                    <span id="notes-save-status" class="notes-save-status"></span>
                    <button id="notes-clear-btn" class="btn btn-secondary btn-small">Clear</button>
                </div>
            </div>

            <!-- Edit PDF Pattern Modal -->
            <div id="pdf-edit-modal" class="modal" style="display: none;">
                <div class="modal-content pdf-edit-modal-content">
                    <div class="modal-header">
                        <h2>Edit Pattern</h2>
                        <button class="modal-close" id="close-pdf-edit-modal">&times;</button>
                    </div>
                    <div class="pdf-edit-form">
                        <div class="form-group">
                            <label for="pdf-edit-name">Pattern Name <span class="required">required</span></label>
                            <input type="text" id="pdf-edit-name" required>
                        </div>
                        <div class="form-group">
                            <label>Category <span class="required">required</span></label>
                            <div id="pdf-edit-category-container">
                                <!-- Category dropdown will be populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pdf-edit-description">Description <span class="required">optional</span></label>
                            <textarea id="pdf-edit-description" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Hashtags <span class="required">optional</span></label>
                            <div id="pdf-edit-hashtags-container">
                                <!-- Hashtag selector will be populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Thumbnail</label>
                            <div class="thumbnail-selector" id="pdf-edit-thumbnail-selector" data-target="pdf-edit">
                                <div class="thumbnail-selector-preview" id="pdf-edit-thumbnail-preview">
                                    <span class="thumbnail-selector-placeholder">+</span>
                                </div>
                            </div>
                            <small class="form-hint">Click to select or paste an image</small>
                        </div>
                        <div class="form-group mark-current-toggle">
                            <span class="mark-current-label">Mark as in progress</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pdf-edit-is-current">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="pdf-revert-btn">Revert Annotations</button>
                        <button type="button" class="btn btn-danger" id="delete-pdf-pattern">Delete Pattern</button>
                        <div class="modal-actions-right">
                            <button type="button" class="btn btn-secondary" id="cancel-pdf-edit">Cancel</button>
                            <button type="button" class="btn btn-primary" id="save-pdf-edit">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern Info Modal -->
            <div id="pattern-info-modal" class="modal" style="display: none;">
                <div class="modal-content pattern-info-modal-content">
                    <div class="modal-header">
                        <h2>Pattern Info</h2>
                        <button class="modal-close" id="close-pattern-info-modal">&times;</button>
                    </div>
                    <div class="pattern-info-content">
                        <div class="info-grid" id="pattern-info-grid">
                            <!-- Info will be populated dynamically -->
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="close-pattern-info-btn">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Pattern Viewer -->
    <div id="markdown-viewer-container" class="markdown-viewer-container" style="display: none;">
        <div class="markdown-header">
            <div class="markdown-header-left">
                <button id="markdown-back-btn" class="btn btn-secondary">‚Üê Back</button>
                <button id="markdown-notes-btn" class="btn btn-secondary">Notes</button>
                <button id="markdown-edit-btn" class="btn btn-secondary">Edit</button>
                <button id="markdown-info-btn" class="btn btn-secondary">Info</button>
            </div>
            <h2 id="markdown-pattern-name"></h2>
            <div class="markdown-header-right">
                <div class="timer-control">
                    <label class="auto-timer-toggle" title="Auto timer: runs while viewing, pauses on inactivity">
                        <input type="checkbox" id="markdown-auto-timer-checkbox">
                        <span class="auto-timer-slider"></span>
                        <span class="auto-timer-label">Auto</span>
                    </label>
                    <button id="markdown-timer-btn" class="btn btn-secondary timer-btn">
                        <svg class="timer-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="markdown-timer-display">0:00:00</span>
                    </button>
                    <button id="markdown-timer-reset-btn" class="timer-reset-btn" title="Reset timer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="markdown-viewer-wrapper">
            <div id="markdown-content" class="markdown-content">
                <!-- Rendered markdown content will go here -->
            </div>
        </div>

        <!-- Counter overlay is shared - see #shared-counter-overlay -->

        <!-- Notes Popover (reuse same structure) -->
        <div id="markdown-notes-popover" class="notes-popover" style="display: none;">
            <div class="notes-popover-header">
                <div class="notes-tabs">
                    <button class="notes-tab active" data-tab="edit">Edit</button>
                    <button class="notes-tab" data-tab="preview">Preview</button>
                </div>
                <button id="markdown-notes-close-btn" class="notes-close">&times;</button>
            </div>
            <div class="notes-popover-body">
                <textarea id="markdown-notes-editor" placeholder="Write your notes here... Markdown supported!"></textarea>
                <div id="markdown-notes-preview" class="notes-preview" style="display: none;"></div>
            </div>
            <div class="notes-popover-footer">
                <label class="notes-live-preview-label">
                    <input type="checkbox" id="markdown-notes-live-preview">
                    <span>Live preview</span>
                </label>
                <span id="markdown-notes-save-status" class="notes-save-status"></span>
                <button id="markdown-notes-clear-btn" class="btn btn-secondary btn-small">Clear</button>
            </div>
        </div>

        <!-- Edit Pattern Content Modal -->
        <div id="markdown-edit-modal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Edit Pattern</h2>
                    <div class="markdown-edit-tabs">
                        <button type="button" class="markdown-edit-tab active" data-tab="edit">Edit</button>
                        <button type="button" class="markdown-edit-tab" data-tab="preview">Preview</button>
                        <label class="markdown-edit-live-preview-label">
                            <input type="checkbox" id="markdown-edit-live-preview">
                            <span>Live preview</span>
                        </label>
                    </div>
                    <button class="modal-close" id="close-markdown-edit-modal">&times;</button>
                </div>
                <div class="markdown-edit-wrapper">
                    <div class="markdown-edit-sidebar">
                        <div class="form-group">
                            <label for="markdown-edit-name">Pattern Name <span class="required">required</span></label>
                            <input type="text" id="markdown-edit-name" required>
                        </div>
                        <div class="form-group">
                            <label>Category <span class="required">required</span></label>
                            <div id="markdown-edit-category-container">
                                <!-- Category dropdown will be populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="markdown-edit-description">Description <span class="required">optional</span></label>
                            <textarea id="markdown-edit-description" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Hashtags <span class="required">optional</span></label>
                            <div id="markdown-edit-hashtags-container">
                                <!-- Hashtag selector will be populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Thumbnail <span class="required">optional</span></label>
                            <div class="thumbnail-selector" id="markdown-edit-thumbnail-selector" data-target="markdown-edit">
                                <div class="thumbnail-selector-preview" id="markdown-edit-thumbnail-preview">
                                    <span class="thumbnail-selector-placeholder">+</span>
                                </div>
                            </div>
                            <small class="form-hint">Click to select or paste an image</small>
                        </div>
                        <div class="form-group mark-current-toggle">
                            <span class="mark-current-label">Mark as in progress</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="markdown-edit-is-current">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="markdown-edit-main">
                        <div class="markdown-edit-body edit-mode">
                            <textarea id="markdown-edit-content" placeholder="Edit pattern content..."></textarea>
                            <div id="markdown-edit-preview" class="markdown-edit-preview"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-markdown-pattern">Delete Pattern</button>
                    <div class="modal-actions-right">
                        <button type="button" class="btn btn-secondary" id="cancel-markdown-edit">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-markdown-edit">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Pattern Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Pattern</h2>
                <button class="modal-close" id="close-edit-modal">&times;</button>
            </div>
            <form id="edit-form">
                <div class="form-group">
                    <label for="edit-pattern-name">Pattern Name <span class="required">required</span></label>
                    <input type="text" id="edit-pattern-name" required>
                </div>
                <div class="form-group">
                    <label>Category <span class="required">required</span></label>
                    <div id="edit-pattern-category-container">
                        <!-- Category dropdown will be populated dynamically -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-pattern-description">Description <span class="required">optional</span> <span class="char-counter"><span id="edit-desc-count">0</span>/45</span></label>
                    <textarea id="edit-pattern-description" rows="2" maxlength="45" oninput="document.getElementById('edit-desc-count').textContent = this.value.length"></textarea>
                </div>
                <div class="form-group">
                    <label>Hashtags <span class="required">optional</span></label>
                    <div id="edit-pattern-hashtags-container">
                        <!-- Hashtag selector will be populated dynamically -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Thumbnail <span class="required">optional</span></label>
                    <div class="thumbnail-selector" id="edit-thumbnail-selector" data-target="edit">
                        <div class="thumbnail-selector-preview" id="edit-thumbnail-preview">
                            <span class="thumbnail-selector-placeholder">+</span>
                        </div>
                    </div>
                    <p class="help-text">Click to select or paste an image</p>
                </div>
                <div class="form-group mark-current-toggle">
                    <span class="mark-current-label">Mark as in progress</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="edit-is-current">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-edit-pattern">Delete Pattern</button>
                    <div class="modal-actions-right">
                        <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Thumbnail Selector Modal -->
    <div id="thumbnail-modal" class="modal" style="display: none;">
        <div class="modal-content thumbnail-modal-content">
            <div class="modal-header">
                <h2>Select Thumbnail</h2>
                <button class="modal-close" id="close-thumbnail-modal">&times;</button>
            </div>
            <div class="thumbnail-modal-body">
                <div class="thumbnail-preview-area" id="thumbnail-preview-area">
                    <div class="thumbnail-placeholder" id="thumbnail-placeholder">
                        <span class="thumbnail-placeholder-icon">üñºÔ∏è</span>
                        <p>No image selected</p>
                    </div>
                    <img id="thumbnail-preview-img" class="thumbnail-preview-img" style="display: none;" alt="Thumbnail preview">
                </div>
                <div class="thumbnail-actions">
                    <button type="button" class="btn btn-secondary thumbnail-action-btn" id="thumbnail-browse-btn">
                        <span class="btn-icon">üìÅ</span>
                        <span>Browse Files</span>
                    </button>
                    <button type="button" class="btn btn-secondary thumbnail-action-btn" id="thumbnail-paste-btn">
                        <span class="btn-icon">üìã</span>
                        <span>Paste from Clipboard</span>
                    </button>
                    <input type="file" id="thumbnail-file-input" accept="image/*" hidden>
                </div>
                <p class="thumbnail-hint">You can also paste an image directly (Ctrl+V / Cmd+V)</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="thumbnail-clear-btn">Clear</button>
                <button type="button" class="btn btn-secondary" id="cancel-thumbnail-btn">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-thumbnail-btn">Use This Image</button>
            </div>
        </div>
    </div>

    <!-- Duplicate File Modal -->
    <div id="duplicate-modal" class="modal" style="display: none;">
        <div class="modal-content duplicate-modal-content">
            <div class="modal-header">
                <h2>Duplicate File Detected</h2>
                <button class="modal-close" id="close-duplicate-modal">&times;</button>
            </div>
            <div class="duplicate-modal-body">
                <p>A pattern with this filename already exists:</p>
                <div class="duplicate-file-info">
                    <span class="duplicate-filename" id="duplicate-filename"></span>
                </div>
                <p class="duplicate-question">What would you like to do?</p>
            </div>
            <div class="modal-actions duplicate-modal-actions">
                <button type="button" class="btn btn-secondary" id="duplicate-cancel-btn">Skip</button>
                <button type="button" class="btn btn-warning" id="duplicate-overwrite-btn">Overwrite</button>
                <button type="button" class="btn btn-primary" id="duplicate-rename-btn">Rename</button>
            </div>
        </div>
    </div>

    <div id="mascot-modal" class="modal" style="display: none;">
        <div class="modal-content mascot-modal-content">
            <div class="modal-header">
                <h3>Choose Mascot</h3>
                <button class="modal-close" id="close-mascot-modal">&times;</button>
            </div>
            <div id="mascot-grid" class="mascot-grid">
                <p>Loading mascots...</p>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal" style="display: none;" onclick="closeAddUserModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <div class="setting-info">
                        <label for="new-user-username">Username</label>
                    </div>
                    <input type="text" id="new-user-username" class="settings-input" placeholder="Enter username">
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label for="new-user-password">Password (optional)</label>
                    </div>
                    <input type="password" id="new-user-password" class="settings-input" placeholder="Leave blank for passwordless">
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Admin</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-admin">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Can Add Patterns</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-can-add" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Require Password</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-require-pw">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Allow SSO</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-allow-sso" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Can Change Username</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-change-username" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <label>Can Change Password</label>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-user-change-password" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                <button id="add-user-btn" class="btn btn-primary">Create User</button>
            </div>
        </div>
    </div>

    <script>
        // Instant PWA restore: inject last-seen content before JS loads
        // This makes the first paint show content instead of an empty shell
        if (localStorage.getItem('authenticated') === 'true' && !localStorage.getItem('viewingPatternId')) {
            var _vt = localStorage.getItem('cachedViewTab');
            var _vh = localStorage.getItem('cachedViewHTML');
            if (_vt && _vh) {
                var _el = document.getElementById(_vt);
                if (_el) {
                    _el.innerHTML = _vh;
                    _el.classList.add('active'); // So initTabs() takes fast path ‚Äî no hide/show cycle
                    window.__cachedViewRestored = true;
                }
            }
        }
    </script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script defer src="app.js?v=152"></script>
</body>
</html>
